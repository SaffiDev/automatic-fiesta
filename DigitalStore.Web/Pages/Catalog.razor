@page "/catalog"
@using DigitalStore.Application.DTOs
@using DigitalStore.Web.Services
@inject SupabaseService Supabase
@inject NavigationManager Navigation

<PageTitle>Каталог — Digital Store</PageTitle>

<div class="container my-5">
    <h1 class="mb-5 text-center">Каталог цифровых товаров</h1>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <p class="lead">Загрузка товаров из базы...</p>
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <h4>Ошибка загрузки</h4>
            <p>@errorMessage</p>
            <hr />
            @if (!string.IsNullOrEmpty(errorDetails))
            {
                <pre style="font-size: 12px; max-height: 300px; overflow-y: auto;">@errorDetails</pre>
            }
        </div>
    }
    else
    {
        <!-- Фильтр по категориям -->
        <div class="mb-5 text-center">
            <button class="btn @(selectedCategoryId == 0 ? "btn-primary" : "btn-outline-primary") me-3 mb-2" 
                    @onclick="() => FilterCategory(0)">
                Все товары (@products.Count)
            </button>
            @if (activeCategories != null && activeCategories.Any())
            {
                @foreach (var category in activeCategories)
                {
                    <button class="btn @(selectedCategoryId == category.Id ? "btn-primary" : "btn-outline-primary") me-3 mb-2" 
                            @onclick="() => FilterCategory(category.Id)">
                        @category.Name
                    </button>
                }
            }
        </div>

        @if (filteredProducts == null || !filteredProducts.Any())
        {
            <p class="text-center text-muted fs-4">Товаров в этой категории пока нет.</p>
        }
        else
        {
            <div class="row row-cols-1 row-cols-md-3 g-5">
                @foreach (var product in filteredProducts)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm border-0 hover-shadow">
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px;">
                                <span class="display-1 opacity-50">@GetProductIcon(product?.ProductType ?? "")</span>
                            </div>

                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title mb-3">@(product?.Name ?? "Без названия")</h5>

                                @if (!string.IsNullOrEmpty(product?.Author))
                                {
                                    <p class="card-text text-muted small mb-1">Автор: @product.Author</p>
                                }
                                @if (!string.IsNullOrEmpty(product?.Publisher))
                                {
                                    <p class="card-text text-muted small mb-2">@product.Publisher</p>
                                }

                                <div class="mt-auto">
                                    <p class="card-text mb-4">
                                        <strong class="text-success display-6">@((product?.Price ?? 0).ToString("F0")) ₽</strong>
                                    </p>
                                    <button class="btn btn-primary btn-lg w-100" @onclick="() => GoToProduct(product?.Id ?? 0)">
                                        Подробнее
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private List<ProductDto> products = new();
    private List<CategoryDto> categories = new();
    private List<ProductDto> filteredProducts = new();
    private List<CategoryDto> activeCategories = new();

    private bool isLoading = true;
    private string? errorMessage;
    private string? errorDetails;
    private int selectedCategoryId = 0;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("=== НАЧАЛО ЗАГРУЗКИ ===");
        
        try
        {
            isLoading = true;
            Console.WriteLine("1. Начинаем загрузку товаров...");
            
            // Загружаем товары
            var loadedProducts = await Supabase.GetProductsAsync();
            Console.WriteLine($"2. Товары загружены: {loadedProducts?.Count ?? 0} шт");
            
            products = loadedProducts ?? new List<ProductDto>();
            Console.WriteLine($"3. Список товаров инициализирован: {products.Count} шт");

            // Загружаем категории
            Console.WriteLine("4. Начинаем загрузку категорий...");
            var loadedCategories = await Supabase.GetCategoriesAsync();
            Console.WriteLine($"5. Категории загружены: {loadedCategories?.Count ?? 0} шт");
            
            categories = loadedCategories ?? new List<CategoryDto>();
            Console.WriteLine($"6. Список категорий инициализирован: {categories.Count} шт");

            // Фильтруем активные категории
            Console.WriteLine("7. Фильтруем активные категории...");
            activeCategories = categories.Where(c => c != null && c.IsActive).ToList();
            Console.WriteLine($"8. Активных категорий: {activeCategories.Count} шт");

            // Показываем все товары по умолчанию
            Console.WriteLine("9. Применяем фильтр по умолчанию...");
            FilterCategory(0);
            Console.WriteLine($"10. Отфильтровано товаров: {filteredProducts.Count} шт");
            
            Console.WriteLine("=== ЗАГРУЗКА ЗАВЕРШЕНА УСПЕШНО ===");
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка: {ex.GetType().Name} - {ex.Message}";
            errorDetails = $"StackTrace:\n{ex.StackTrace}\n\nInnerException: {ex.InnerException?.Message}";
            
            Console.WriteLine($"!!! ОШИБКА: {ex.GetType().Name}");
            Console.WriteLine($"!!! Сообщение: {ex.Message}");
            Console.WriteLine($"!!! StackTrace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"!!! InnerException: {ex.InnerException.Message}");
                Console.WriteLine($"!!! Inner StackTrace: {ex.InnerException.StackTrace}");
            }
            
            // Инициализируем пустые списки
            products = new List<ProductDto>();
            categories = new List<CategoryDto>();
            filteredProducts = new List<ProductDto>();
            activeCategories = new List<CategoryDto>();
        }
        finally
        {
            isLoading = false;
            Console.WriteLine("=== ЗАВЕРШЕНИЕ МЕТОДА OnInitializedAsync ===");
        }
    }

    private void FilterCategory(int categoryId)
    {
        Console.WriteLine($"FilterCategory вызван с ID: {categoryId}");
        
        try
        {
            selectedCategoryId = categoryId;
            
            if (products == null)
            {
                Console.WriteLine("!!! products = null");
                filteredProducts = new List<ProductDto>();
                return;
            }

            Console.WriteLine($"Всего товаров: {products.Count}");

            if (categoryId == 0)
            {
                filteredProducts = products.Where(p => p != null && p.IsActive).ToList();
                Console.WriteLine($"Выбраны все товары: {filteredProducts.Count} шт");
            }
            else
            {
                filteredProducts = products
                    .Where(p => p != null && p.IsActive && p.CategoryId == categoryId)
                    .ToList();
                Console.WriteLine($"Отфильтровано по категории {categoryId}: {filteredProducts.Count} шт");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"!!! ОШИБКА в FilterCategory: {ex.Message}");
            Console.WriteLine($"!!! StackTrace: {ex.StackTrace}");
            filteredProducts = new List<ProductDto>();
        }
    }

    private void GoToProduct(int id)
    {
        Console.WriteLine($"Переход к товару ID: {id}");
        try
        {
            Navigation.NavigateTo($"/product/{id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"!!! ОШИБКА навигации: {ex.Message}");
        }
    }

    private string GetProductIcon(string? type)
    {
        if (string.IsNullOrEmpty(type)) return "📦";
        
        return type.ToLower() switch
        {
            "music" => "🎵",
            "book" => "📖",
            "software" => "💻",
            _ => "📦"
        };
    }
}