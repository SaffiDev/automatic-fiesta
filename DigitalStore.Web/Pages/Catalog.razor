@page "/catalog"
@using DigitalStore.Application.DTOs
@using DigitalStore.Web.Services
@inject SupabaseService Supabase
@inject NavigationManager Navigation
@inject WishlistService WishlistService  
@inject AuthService AuthService         

<PageTitle>Каталог — Digital Store</PageTitle>

<div class="container my-5">
    <h1 class="mb-5 text-center">Каталог цифровых товаров</h1>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <p class="lead">Загрузка товаров из базы...</p>
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <h4>Ошибка загрузки</h4>
            <p>@errorMessage</p>
            <hr />
            @if (!string.IsNullOrEmpty(errorDetails))
            {
                <pre style="font-size: 12px; max-height: 300px; overflow-y: auto;">@errorDetails</pre>
            }
        </div>
    }
    else
    {
        <!-- Фильтр по категориям -->
        <div class="mb-5 text-center">
            <button class="btn @(selectedCategoryId == 0 ? "btn-primary" : "btn-outline-primary") me-3 mb-2"
                    @onclick="() => FilterCategory(0)">
                Все товары (@products.Count)
            </button>
            @if (activeCategories != null && activeCategories.Any())
            {
                @foreach (var category in activeCategories)
                {
                    <button class="btn @(selectedCategoryId == category.Id ? "btn-primary" : "btn-outline-primary") me-3 mb-2"
                            @onclick="() => FilterCategory(category.Id)">
                        @category.Name
                    </button>
                }
            }
        </div>

        @if (filteredProducts == null || !filteredProducts.Any())
        {
            <p class="text-center text-muted fs-4">Товаров в этой категории пока нет.</p>
        }
        else
        {
            <div class="row row-cols-1 row-cols-md-3 g-5">
                @foreach (var product in filteredProducts)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm border-0 hover-shadow position-relative">
                            <!-- КНОПКА ИЗБРАННОГО В УГЛУ КАРТОЧКИ -->
                            @if (AuthService.IsAuthenticated)
                            {
                                <div class="position-absolute top-0 end-0 p-2" style="z-index: 10;">
                                    @if (wishlistStatus.TryGetValue(product.Id, out var isInWishlist) && isInWishlist)
                                    {
                                        <button class="btn btn-danger btn-sm rounded-circle shadow"
                                                @onclick="() => ToggleWishlist(product.Id)"
                                                @onclick:preventDefault
                                                @onclick:stopPropagation>
                                            <i class="bi bi-heart-fill"></i>
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-outline-danger btn-sm rounded-circle shadow"
                                                @onclick="() => ToggleWishlist(product.Id)"
                                                @onclick:preventDefault
                                                @onclick:stopPropagation>
                                            <i class="bi bi-heart"></i>
                                        </button>
                                    }
                                </div>
                            }

                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px;">
                                <span class="display-1 opacity-50">@GetProductIcon(product?.ProductType ?? "")</span>
                            </div>

                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title mb-3">@(product?.Name ?? "Без названия")</h5>

                                @if (!string.IsNullOrEmpty(product?.Author))
                                {
                                    <p class="card-text text-muted small mb-1">Автор: @product.Author</p>
                                }
                                @if (!string.IsNullOrEmpty(product?.Publisher))
                                {
                                    <p class="card-text text-muted small mb-2">@product.Publisher</p>
                                }

                                <div class="mt-auto">
                                    <p class="card-text mb-4">
                                        <strong class="text-success display-6">@((product?.Price ?? 0).ToString("F0")) ₽</strong>
                                    </p>
                                    <button class="btn btn-primary btn-lg w-100"
                                            @onclick="() => GoToProduct(product?.Id ?? 0)">
                                        Подробнее
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private List<ProductDto> products = new();
    private List<CategoryDto> categories = new();
    private List<ProductDto> filteredProducts = new();
    private List<CategoryDto> activeCategories = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string? errorDetails;
    private int selectedCategoryId = 0;

    // Словарь для хранения статуса избранного по ID товара
    private Dictionary<int, bool> wishlistStatus = new();

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("=== НАЧАЛО ЗАГРУЗКИ ===");
        try
        {
            isLoading = true;

            var loadedProducts = await Supabase.GetProductsAsync();
            products = loadedProducts ?? new List<ProductDto>();

            var loadedCategories = await Supabase.GetCategoriesAsync();
            categories = loadedCategories ?? new List<CategoryDto>();

            activeCategories = categories.Where(c => c != null && c.IsActive).ToList();

            // Загружаем статус избранного для всех товаров (только если залогинен)
            if (AuthService.IsAuthenticated)
            {
                var wishlistProducts = await WishlistService.GetWishlistProductsAsync();
                foreach (var p in products)
                {
                    wishlistStatus[p.Id] = wishlistProducts.Any(wp => wp.Id == p.Id);
                }
            }

            FilterCategory(0);
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка: {ex.GetType().Name} - {ex.Message}";
            errorDetails = ex.ToString();
            products = new();
            categories = new();
            filteredProducts = new();
            activeCategories = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterCategory(int categoryId)
    {
        selectedCategoryId = categoryId;

        if (categoryId == 0)
        {
            filteredProducts = products.Where(p => p != null && p.IsActive).ToList();
        }
        else
        {
            filteredProducts = products
                .Where(p => p != null && p.IsActive && p.CategoryId == categoryId)
                .ToList();
        }
    }

    private async Task ToggleWishlist(int productId)
    {
        if (!AuthService.IsAuthenticated) return;

        bool currentStatus = wishlistStatus.GetValueOrDefault(productId, false);

        if (currentStatus)
        {
            await WishlistService.RemoveFromWishlistAsync(productId);
        }
        else
        {
            await WishlistService.AddToWishlistAsync(productId);
        }

        // Обновляем статус
        wishlistStatus[productId] = !currentStatus;
    }

    private void GoToProduct(int id)
    {
        Navigation.NavigateTo($"/product/{id}");
    }

    private string GetProductIcon(string? type)
    {
        if (string.IsNullOrEmpty(type)) return "📦";
        return type.ToLower() switch
        {
            "music" => "🎵",
            "book" => "📖",
            "software" => "💻",
            _ => "📦"
        };
    }
}