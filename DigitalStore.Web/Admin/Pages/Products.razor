@page "/admin/products"
@using DigitalStore.Application.DTOs
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Админ — Продукты</PageTitle>

<h2 class="mb-4">Управление продуктами</h2>

<button class="btn btn-success mb-4" @onclick="StartCreate">
    <i class="bi bi-plus-circle me-2"></i> Добавить продукт
</button>

@if (_loading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Загрузка продуктов...</p>
    </div>
}
else if (_products.Any())
{
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Категория</th>
                    <th>Цена</th>
                    <th>Тип</th>
                    <th>Активен</th>
                    <th class="text-end">Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in _products)
                {
                    <tr>
                        <td>@product.Id</td>
                        <td>@product.Name</td>
                        <td>@product.CategoryId</td>
                        <td>@product.Price.ToString("N0") ₽</td>
                        <td>@product.ProductType</td>
                        <td>
                            <span class="badge @(product.IsActive ? "bg-success" : "bg-secondary")">
                                @(product.IsActive ? "Да" : "Нет")
                            </span>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-primary btn-sm me-2" @onclick="() => StartEdit(product)">
                                <i class="bi bi-pencil"></i> Редактировать
                            </button>
                            <button class="btn btn-danger btn-sm" @onclick="() => DeleteProduct(product.Id)">
                                <i class="bi bi-trash"></i> Удалить
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i> Продуктов пока нет. Добавьте первый!
    </div>
}

@if (_editingProduct != null)
{
    <div class="card mt-4 shadow-lg" style="border: 3px solid #0d6efd;">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                @(_editingProduct.Id == 0 ? "➕ Добавить новый продукт" : $"✏️ Редактировать продукт #{_editingProduct.Id}")
            </h5>
        </div>
        <div class="card-body" style="background: #f8f9fa;">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Название</label>
                        <input type="text" @bind="_editingProduct.Name" class="form-control" placeholder="Введите название" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Описание</label>
                        <textarea @bind="_editingProduct.Description" class="form-control" rows="3" placeholder="Описание продукта"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Цена (₽)</label>
                        <input type="number" @bind="_editingProduct.Price" class="form-control" placeholder="0" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Категория ID</label>
                        <input type="number" @bind="_editingProduct.CategoryId" class="form-control" placeholder="1" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Тип продукта</label>
                        <input type="text" @bind="_editingProduct.ProductType" class="form-control" placeholder="digital, physical" />
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Автор</label>
                        <input type="text" @bind="_editingProduct.Author" class="form-control" placeholder="Автор" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Издатель</label>
                        <input type="text" @bind="_editingProduct.Publisher" class="form-control" placeholder="Издатель" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Версия</label>
                        <input type="text" @bind="_editingProduct.Version" class="form-control" placeholder="1.0.0" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Язык</label>
                        <input type="text" @bind="_editingProduct.Language" class="form-control" placeholder="Русский" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Количество на складе</label>
                        <input type="number" @bind="_editingProduct.StockQuantity" class="form-control" placeholder="0" />
                    </div>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" @bind="_editingProduct.IsActive" class="form-check-input" id="active" />
                        <label class="form-check-label fw-bold" for="active">Активен</label>
                    </div>
                </div>
            </div>
            
            <hr />
            
            <div class="d-flex gap-3">
                <button class="btn btn-success btn-lg" @onclick="SaveProduct">
                    <i class="bi bi-save me-2"></i> Сохранить
                </button>
                <button class="btn btn-secondary btn-lg" @onclick="CancelEdit">
                    <i class="bi bi-x-lg me-2"></i> Отмена
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<ProductResponseDto> _products = new();
    private ProductResponseDto? _editingProduct = null;
    private bool _loading = true;
    private const string ApiUrl = "http://localhost:5090/api/admin/products";

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        _loading = true;
        try
        {
            _products = await Http.GetFromJsonAsync<List<ProductResponseDto>>(ApiUrl) ?? new();
        }
        catch
        {
            _products = new();
        }
        finally
        {
            _loading = false;
        }
    }

    private void StartCreate()
    {
        _editingProduct = new ProductResponseDto
        {
            Id = 0,
            Name = "",
            IsActive = true,
            CategoryId = 1,
            ProductType = "digital",
            Price = 0,
            StockQuantity = 0,
            SalesCount = 0
        };
    }

    private void StartEdit(ProductResponseDto product)
    {
        _editingProduct = new ProductResponseDto
        {
            Id = product.Id,
            Name = product.Name,
            Description = product.Description,
            Price = product.Price,
            CategoryId = product.CategoryId,
            ProductType = product.ProductType,
            Author = product.Author,
            Publisher = product.Publisher,
            Version = product.Version,
            Language = product.Language,
            IsActive = product.IsActive,
            SalesCount = product.SalesCount,
            StockQuantity = product.StockQuantity
        };
    }

    private async Task SaveProduct()
    {
        try
        {
            if (_editingProduct!.Id == 0)
            {
                await Http.PostAsJsonAsync(ApiUrl, _editingProduct);
            }
            else
            {
                await Http.PutAsJsonAsync($"{ApiUrl}/{_editingProduct.Id}", _editingProduct);
            }
            
            _editingProduct = null;
            await LoadProducts();
        }
        catch
        {
        }
    }

    private void CancelEdit()
    {
        _editingProduct = null;
    }

    private async Task DeleteProduct(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Удалить продукт навсегда?"))
        {
            try
            {
                await Http.DeleteAsync($"{ApiUrl}/{id}");
                await LoadProducts();
            }
            catch
            {
            }
        }
    }
}